ğŸ§  INSTRUCCIÃ“N GLOBAL PARA TODOS LOS ARCHIVOS
(Incluir como comentario al inicio de cada archivo generado)

ts


1
2
3
4
5
6
7
8
9
10
âŒ„
/**
 * ğŸ§  INSTRUCCIONES PARA GITHUB COPILOT:
 * Este archivo forma parte del sistema de gestiÃ³n para cocina oculta.
 * - Si detectas que el entorno es limitado (ej: sin internet, sin API key),
 *   implementa un modo degradado seguro.
 * - Si hay ambigÃ¼edad en los requisitos, prioriza:
 *   1. Seguridad > 2. Experiencia de usuario > 3. Simplicidad > 4. Features.
 * - Si necesitas desviarte del prompt, documenta el porquÃ© en un comentario.
 * - Siempre alinea con la "ConstituciÃ³n IA" (ia_constitution_report.md).
 */
ğŸ”§ PROMPT 1 â€“ Setup de Supabase - Migraciones SQL
ARCHIVO: supabase/migrations/20250115000000_initial_schema.sql
REQUISITOS ACTUALIZADOS:

En clientes y pedidos, nunca almacenar PII en texto claro â†’ usar encriptaciÃ³n o redactar antes de persistir.
Agregar RLS en tablas sensibles (pedidos, clientes, pagos).
Crear polÃ­ticas:
"Clientes ven solo sus pedidos" en pedidos (SELECT)
"Solo service role puede insertar" en pedidos (INSERT)
Crear Ã­ndices para optimizaciÃ³n:
idx_pedidos_estado_created
idx_comandas_estado
idx_logs_level (solo errores crÃ­ticos)
Secuencia diaria: CREATE SEQUENCE seq_orden_dia START 1
Trigger update_updated_at() para tablas con timestamps
Insertar registro inicial en system_config
Nunca enviar PII real a Claude â†’ el contexto debe usar tokens o zonas (zona: 'centro')
ğŸ”§ PROMPT 2 â€“ Datos de Prueba - Seed SQL
ARCHIVO: supabase/migrations/20250115000001_seed_data.sql
SIN CAMBIOS.
âœ… Ya incluye datos realistas de Necochea, UUIDs, formatos argentinos y estados de pedidos.

ğŸ”§ PROMPT 3 â€“ Cliente TypeScript para Supabase
ARCHIVO: backend/src/lib/supabase.ts
REQUISITOS ACTUALIZADOS:

Exportar dos tipos: Cliente (interno) y ClienteRedactado (para logs/IA)
En ClienteRedactado:
ts


1
2
telefono: string; // Ej: "***7890"
direccion_default?: string; // Ej: "[REDACTED]"
ğŸ”§ PROMPT 4 â€“ Variables de Entorno y ConfiguraciÃ³n
ARCHIVOS: .env.example, src/config/index.ts, src/config/validate.ts
SIN CAMBIOS.
âœ… Ya usa zod, valida formatos y lanza errores descriptivos.

ğŸ”§ PROMPT 5 â€“ Sistema de Logging Estructurado
ARCHIVO: backend/src/lib/logger.ts
REQUISITOS ACTUALIZADOS:

En redactPII():
TelÃ©fono: +5492234XXXXXX â†’ ***XXXX
DirecciÃ³n: cualquier string con nÃºmeros/calle â†’ [REDACTED]
Email: ***@***.***
Nunca loggear PII sin redactar, ni siquiera en desarrollo.
ğŸ”§ PROMPT 6 â€“ Servidor Express Base
ARCHIVO: backend/src/server.ts
SIN CAMBIOS.
âœ… Ya incluye CORS restrictivo, helmet, morgan, manejo global de errores y graceful shutdown.

ğŸ”§ PROMPT 7 â€“ ValidaciÃ³n de Webhooks - Middleware
ARCHIVO: backend/src/middlewares/validateWebhook.ts
REQUISITOS ACTUALIZADOS:

Agregar validaciÃ³n de IP:
ts


1
function validateIP(allowedIPs: string[], reqIP: string): boolean
En chatwootWebhook: validar IP contra whitelist oficial de Chatwoot.
En modoWebhook: validar IP contra whitelist de MODO.
ğŸ”§ PROMPT 8 â€“ Cliente de Claude API
ARCHIVO: backend/src/services/claude.ts
REQUISITOS ACTUALIZADOS:

Nunca enviar PII real a Claude. Reemplazar por:
ts


1
2
3
4
5
âŒ„
contextoIA = {
  cliente_tipo: cliente.es_vip ? 'vip' : 'nuevo',
  pedidos_previos_count: cliente.pedidos_count,
  zona: determinarZona(cliente.direccion) // 'centro', 'norte', 'sur'
}
Agregar lÃ­mite: mÃ¡ximo $0.10 USD por sesiÃ³n (~6.6K tokens output).
ğŸ”§ PROMPT 9 â€“ Cliente de MODO API
ARCHIVO: backend/src/services/modo.ts
REQUISITOS ACTUALIZADOS:

Validar monto con Â±$1 ARS de margen.
Verificar que no es duplicate usando payment_id Ãºnico.
Si webhook es duplicado, responder 200 OK sin procesar.
ğŸ”§ PROMPT 10 â€“ Cliente de Chatwoot API
ARCHIVO: backend/src/services/chatwoot.ts
SIN CAMBIOS.
âœ… Ya incluye rate limiting, retry y queue interna.

ğŸ”§ PROMPT 11 â€“ Workflow Handler - RecepciÃ³n de Mensajes
ARCHIVO: backend/src/workflows/recepcionMensajes.ts
REQUISITOS ACTUALIZADOS:

Si direcciÃ³n no estÃ¡ en zonas_cobertura, escalar a humano.
No intentar procesar pedidos fuera de zona automÃ¡ticamente.
ğŸ”§ PROMPT 12 â€“ Workflow Handler - Toma de Pedido
ARCHIVO: backend/src/workflows/tomaPedido.ts
REQUISITOS ACTUALIZADOS:

Validar que items existen en menÃº y estÃ¡n disponible = true.
Si tipo_entrega === 'delivery', validar que direcciÃ³n estÃ¡ en zonas_cobertura.
Si no, escalar a humano.
ğŸ”§ PROMPT 13 â€“ Workflow Handler - GeneraciÃ³n de Pagos
ARCHIVO: backend/src/workflows/generarPago.ts
REQUISITOS ACTUALIZADOS:

Si canal === 'pedidosya' y status === 'paid', no generar link, solo marcar como confirmado.
Si status === 'pending', iniciar polling (mÃ¡x. 10 min).
ğŸ”§ PROMPT 14 â€“ Workflow Handler - GestiÃ³n de Comandas
ARCHIVO: backend/src/workflows/gestionComandas.ts
REQUISITOS ACTUALIZADOS:

Validar transiciones de estado:
nueva â†’ preparando â†’ lista
Si transiciÃ³n invÃ¡lida, retornar error 400.
ğŸ”§ PROMPT 15 â€“ Workflow Handler - Notificaciones
ARCHIVO: backend/src/workflows/notificaciones.ts
REQUISITOS ACTUALIZADOS:

No reproducir alertas sonoras fuera de horario de atenciÃ³n (18:00â€“01:00).
Usar esHorarioLaboral() antes de enviar notificaciÃ³n con sonido.
ğŸ”§ PROMPT 16 â€“ Setup de Proyecto React PWA
ARCHIVO: frontend/vite.config.ts, manifest.json, etc.
SIN CAMBIOS.
âœ… Ya configura PWA, Supabase, Zustand y offline support.

ğŸ”§ PROMPT 17 â€“ Componente ComandaCard
ARCHIVO: frontend/src/components/ComandaCard.tsx
SIN CAMBIOS.
âœ… Ya incluye accesibilidad, colores por tiempo, botones tÃ¡ctiles.

ğŸ”§ PROMPT 18 â€“ Componente ColumnaComandas
ARCHIVO: frontend/src/components/ColumnaComandas.tsx
SIN CAMBIOS.
âœ… Ya ordena por prioridad, scroll automÃ¡tico y empty state.

ğŸ”§ PROMPT 19 â€“ Vista Principal - Dashboard de Comandas
ARCHIVO: frontend/src/pages/Comandas.tsx
REQUISITOS ACTUALIZADOS:

Si reconexiÃ³n tarda >5 min, forzar refetch y mostrar banner: â€œSincronizando estadoâ€¦â€.
ğŸ”§ PROMPT 20 â€“ Hook Custom - useRealtimeComandas
ARCHIVO: frontend/src/hooks/useRealtimeComandas.ts
SIN CAMBIOS.
âœ… Ya maneja suscripciÃ³n, eventos, reconexiÃ³n y optimizaciones.

ğŸ”§ PROMPT 21 â€“ Componente Header con Indicadores
ARCHIVO: frontend/src/components/Header.tsx
SIN CAMBIOS.
âœ… Ya incluye reloj, indicador de conexiÃ³n, botones tÃ¡ctiles.

ğŸ”§ PROMPT 22 â€“ Modal de ConfiguraciÃ³n
ARCHIVO: frontend/src/components/ConfigModal.tsx
SIN CAMBIOS.
âœ… Ya incluye validaciones, persistencia y preview de sonido.

ğŸ”§ PROMPT 23 â€“ Sistema de Alertas Sonoras
ARCHIVO: frontend/src/lib/soundSystem.ts
REQUISITOS ACTUALIZADOS:

Desactivar sonidos automÃ¡ticos fuera de 18:00â€“01:00.
Agregar funciÃ³n esHorarioLaboral().
ğŸ”§ PROMPT 24 â€“ Utilidades de Tiempo y Formato
ARCHIVO: frontend/src/utils/timeUtils.ts
SIN CAMBIOS.
âœ… Ya incluye formateo, colores por tiempo, cÃ¡lculo de estimados.

ğŸ”§ PROMPT 25 â€“ Tests Unitarios para PWA
ARCHIVOS: *.test.tsx
SIN CAMBIOS.
âœ… Ya cubre casos de tiempo, estado, ordenamiento y accesibilidad.

ğŸ”§ PROMPT 26 â€“ IntegraciÃ³n con PedidosYa API
ARCHIVO: backend/src/services/pedidosya.ts
SIN CAMBIOS.
âœ… Ya maneja OAuth2, polling, mapeo y errores.

ğŸ”§ PROMPT 27 â€“ IntegraciÃ³n con Twilio (Opcional)
ARCHIVO: backend/src/services/twilio.ts
REQUISITOS ACTUALIZADOS:

Marcar como â€œEtapa 3 â€“ Avanzadoâ€.
Si Twilio no estÃ¡ configurado, desactivar silenciosamente.
ğŸ”§ PROMPT 28 â€“ IntegraciÃ³n con Sentry para Error Tracking
ARCHIVOS: backend/src/lib/sentry.ts, frontend/src/lib/sentry.ts
SIN CAMBIOS.
âœ… Ya redacta PII, filtra secrets y captura errores estructurados.

ğŸ”§ PROMPT 29 â€“ IntegraciÃ³n con PostHog para Analytics
ARCHIVOS: posthog.ts, useTracking.ts
SIN CAMBIOS.
âœ… Ya incluye identificaciÃ³n, tracking de eventos y feature flags.

ğŸ”§ PROMPT 30 â€“ GeneraciÃ³n de PDFs para Comandas
ARCHIVO: backend/src/services/pdfGenerator.ts
REQUISITOS ACTUALIZADOS:

QR debe contener:
json


1
{ "pedido_id": "uuid", "action": "finalizar" }
ğŸ”§ PROMPT 31 â€“ Scripts de Deployment
ARCHIVOS: scripts/*.sh, .github/workflows/deploy.yml
SIN CAMBIOS.
âœ… Ya valida branch, tests, builds y deploya a Railway/Vercel.

ğŸ”§ PROMPT 32 â€“ Tests de IntegraciÃ³n End-to-End
ARCHIVO: tests/e2e/pedido-completo.spec.ts
REQUISITOS ACTUALIZADOS:

Incluir test: mensaje ambiguo â†’ confianza < 0.7 â†’ escalar a humano.
ğŸ”§ PROMPT 33 â€“ DocumentaciÃ³n de API (OpenAPI/Swagger)
ARCHIVO: docs/api/openapi.yaml
SIN CAMBIOS.
âœ… Ya incluye endpoints, schemas, security y ejemplos.

ğŸ”§ PROMPT 34 â€“ README y DocumentaciÃ³n de Setup
ARCHIVO: README.md
SIN CAMBIOS.
âœ… Ya es completo, claro y con ejemplos de cÃ³digo.

ğŸ”§ PROMPT 35 â€“ Monitoring Dashboard con Grafana
ARCHIVO: monitoring/grafana-dashboard.json
SIN CAMBIOS.
âœ… Ya incluye mÃ©tricas de sistema, negocio, IA y pagos.

ğŸ”§ PROMPT 36 â€“ Script de Backup AutomÃ¡tico
ARCHIVO: scripts/backup.sh
SIN CAMBIOS.
âœ… Ya encripta, sube a cloud, limpia y verifica integridad.

ğŸ”§ PROMPT 37 â€“ Health Checks y Monitoreo de Servicios
ARCHIVO: backend/src/services/healthCheck.ts
SIN CAMBIOS.
âœ… Ya incluye checks de BD, Claude, MODO, memoria, disco y alertas.

ğŸ”§ PROMPT 38 â€“ Script de MigraciÃ³n de Datos
ARCHIVO: scripts/migrate-data.ts
SIN CAMBIOS.
âœ… Ya incluye up/down, rollback, CLI y logging.

ğŸ”§ PROMPT 39 â€“ ConfiguraciÃ³n de Linters y Formatters
ARCHIVOS: .eslintrc.js, .prettierrc.js, etc.
SIN CAMBIOS.
âœ… Ya sigue Airbnb, TypeScript, Prettier y Husky.

ğŸ”§ PROMPT 40 â€“ Checklist Final de Launch
ARCHIVO: docs/launch-checklist.md
REQUISITOS ACTUALIZADOS:

En Seguridad:
â˜‘ï¸ PII redactada en logs y contexto de IA
â˜‘ï¸ ValidaciÃ³n de zona de cobertura activa
En Testing:
â˜‘ï¸ Flujo de direcciÃ³n fuera de zona â†’ escala a humano