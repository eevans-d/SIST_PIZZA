name: Security - Secret Scan Semanal

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'  # Domingos 03:00 UTC

permissions:
  contents: read
  security-events: write

jobs:
  trufflehog-scan:
    name: Detectar secretos expuestos (Trufflehog)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ejecutar Trufflehog scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --only-verified --no-update

      - name: Fallar si hay secretos encontrados
        if: failure()
        run: |
          echo "::error::¡ALERTA! Trufflehog detectó posibles secretos expuestos."
          echo "Acciones inmediatas:"
          echo "1. Revisar output de Trufflehog arriba"
          echo "2. Rotar credenciales encontradas INMEDIATAMENTE"
          echo "3. Revertir commits con secretos"
          echo "4. Crear issue de seguridad"
          exit 1

      - name: Notificar éxito
        if: success()
        run: |
          echo "✅ Scan completado — No se encontraron secretos verificados"
